---
title: "MVMR"
output: html_document
date: "2023-01-19"
editor_options: 
  chunk_output_type: console
---

```{r packages}
library(tidyverse)    # Data wrangling 
library(TwoSampleMR)  # MR 
library(LDlinkR)      # LD and proxy snps
library(RadialMR)     # Radial MR sensetivity analysis 
library(phenoscanner)
library(MungeSumstats)
# library(tabulizer)

setwd('~/Dropbox/Research/UCSF/Snoring-AD-MR')

# Define column types for summary statistics
coltypes = cols(
  ID = col_character(),
  CHROM = col_double(),
  POS = col_double(),
  REF = col_character(),
  ALT = col_character(),
  AF = col_double(),
  TRAIT = col_character(),
  BETA = col_double(),
  SE = col_double(),
  Z = col_double(),
  P = col_double(),
  N = col_double(),
  OR = col_double(),
  OR_L95 = col_double(),
  OR_U95 = col_double(),
  DIR = col_character(),
  G1000_ID = col_character(),
  G1000_VARIANT = col_character(),
  DBSNP_ID = col_character(),
  DBSNP_VARIANT = col_character(),
  OLD_ID = col_character(),
  OLD_VARIANT = col_character()
)

```

## Exposures
```{r exposure-AD}
AD_path = "~/Dropbox/Research/Data/Summary_Statisitics/Kunkle2019load_stage123.chrall.CPRA_b37.tsv.gz"
AD_ss <- read_tsv(AD_path, comment = "##",  col_types = coltypes, 
                       col_select = c(DBSNP_ID, CHROM, POS, REF, ALT, AF, BETA, SE, Z, P, N))

# Format outcome
AD_exp <- AD_ss %>%
  mutate(Phenotype = "AD") %>%
  format_data(.,
    type = "exposure",
    snps = NULL,
    header = TRUE,
    phenotype_col = "Phenotype",
    snp_col = "DBSNP_ID",
    beta_col = "BETA",
    se_col = "SE",
    eaf_col = "AF",
    effect_allele_col = "ALT",
    other_allele_col = "REF",
    pval_col = "P",
    samplesize_col = "N",
    z_col = "Z",
    chr_col = "CHROM",
    pos_col = "POS",
    log_pval = FALSE
) %>%
  as_tibble()


# Perform LD clumping on SNP data, filter SNPs to make it run faster
AD_clump <- AD_exp %>% 
  filter(pval.exposure < 0.01) %>%
  clump_data(.,
  clump_kb = 10000,
  clump_r2 = 0.001,
  clump_p1 = 1,
  clump_p2 = 1,
  pop = "EUR"
)

AD_dat <- filter(AD_clump, pval.exposure < 5e-8) 


```


```{r bmi}
bmi_path <- "~/Dropbox/Research/Data/Summary_Statisitics/Locke2015bmi.chrall.CPRA_b37.tsv.gz"

bmi_ss <- read_tsv(bmi_path, comment = "##",  col_types = coltypes, 
                       col_select = c(DBSNP_ID, CHROM, POS, REF, ALT, AF, BETA, SE, Z, P, N))


# Format data to TwoSampleMR format
bmi_exp <- bmi_ss %>%
  mutate(Phenotype = "BMI") %>%
  format_data(.,
    type = "exposure",
    snps = NULL,
    header = TRUE,
    phenotype_col = "Phenotype",
    snp_col = "DBSNP_ID",
    beta_col = "BETA",
    se_col = "SE",
    eaf_col = "AF",
    effect_allele_col = "ALT",
    other_allele_col = "REF",
    pval_col = "P",
    chr_col = "CHROM",
    pos_col = "POS",
    log_pval = FALSE
) %>%
  as_tibble()

BMI_clump <- bmi_exp %>% 
  filter(pval.exposure < 0.01) %>%
  clump_data(.,
  clump_kb = 10000,
  clump_r2 = 0.001,
  clump_p1 = 1,
  clump_p2 = 1,
  pop = "EUR"
)

BMI_dat <- filter(BMI_clump, pval.exposure < 5e-8) 


```


## Outcomes
```{r snoring}
snoring_path = "~/Dropbox/Research/Data/Summary_Statisitics/Campos2020snor.chrall.CPRA_b37.tsv.gz"
snoring_ss <- read_tsv(snoring_path, comment = "##",  col_types = coltypes, 
                       col_select = c(DBSNP_ID, CHROM, POS, REF, ALT, AF, BETA, SE, Z, P, N))


# Format data to TwoSampleMR format
snoring_out <- snoring_ss %>%
  mutate(Phenotype = "Snoring") %>%
  format_data(.,
    type = "outcome",
    snps = NULL,
    header = TRUE,
    phenotype_col = "Phenotype",
    snp_col = "DBSNP_ID",
    beta_col = "BETA",
    se_col = "SE",
    eaf_col = "AF",
    effect_allele_col = "ALT",
    other_allele_col = "REF",
    pval_col = "P",
    chr_col = "CHROM",
    pos_col = "POS",
    log_pval = FALSE
) %>%
  as_tibble()

```

```{r snoring_bmi_adj}
snorbmiadj_path <- "~/Dropbox/Research/Data/Summary_Statisitics/Campos2020snorbmiadj.chrall.CPRA_b37.tsv.gz"

snorbmiadj_ss <- read_tsv(snorbmiadj_path, comment = "##",  col_types = coltypes, 
                       col_select = c(DBSNP_ID, CHROM, POS, REF, ALT, AF, BETA, SE, Z, P, N))


# Format data to TwoSampleMR format
snorbmiadj_out <- snorbmiadj_ss %>%
  mutate(Phenotype = "SnoringBMIadj") %>%
  format_data(.,
    type = "outcome",
    snps = NULL,
    header = TRUE,
    phenotype_col = "Phenotype",
    snp_col = "DBSNP_ID",
    beta_col = "BETA",
    se_col = "SE",
    eaf_col = "AF",
    effect_allele_col = "ALT",
    other_allele_col = "REF",
    pval_col = "P",
    chr_col = "CHROM",
    pos_col = "POS",
    log_pval = FALSE
) %>%
  as_tibble()

```

### LD Proxy SNPs 
```{r get_proxies}
munge_proxies <- function(LDLink_file, outcome, outcome_clump){
  LDLink_file_path <- LDLink_file
  proxy_snps <- read_tsv(LDLink_file_path, skip = 1, col_names = F) %>%
  rename(id = X1, func = X2, proxy_snp = X3, coord = X4, alleles = X5, maf = X6, 
         distance = X7, dprime = X8, rsq = X9, correlated_alleles = X10, FORGEdb = X11, RegulomeDB = X12) %>%
  separate(coord, c('chr', 'pos'), sep = ":") %>%
  mutate(snp = ifelse(id == 1, proxy_snp, NA), 
         chr = str_replace(chr, 'chr', ""), 
         chr = as.numeric(chr), 
         pos = as.numeric(pos)) %>%
  fill(snp, .direction = 'down') %>%
  relocate(snp, .before = proxy_snp) %>%
  dplyr::select(-id, -func, -FORGEdb, -RegulomeDB) %>%
  filter(rsq >= 0.8)

# Munge proxy snp and outcome data
proxy_outcome <- left_join(
  proxy_snps, outcome, by = c("proxy_snp" = "SNP")
) %>%
  separate(correlated_alleles, c("target_a1.outcome", "proxy_a1.outcome", 
                                 "target_a2.outcome", "proxy_a2.outcome"), sep = ",|=") %>%
  filter(!is.na(chr.outcome)) %>%
  arrange(snp, -rsq, abs(distance)) %>%
  group_by(snp) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(
     proxy.outcome = TRUE,
     target_snp.outcome = snp,
     proxy_snp.outcome = proxy_snp, 
  ) %>% 
  mutate(
       new_effect_allele.outcome = case_when(
        proxy_a1.outcome == effect_allele.outcome & proxy_a2.outcome == other_allele.outcome ~ target_a1.outcome,
        proxy_a2.outcome == effect_allele.outcome & proxy_a1.outcome == other_allele.outcome ~ target_a2.outcome,
        TRUE ~ NA_character_
     ), 
      new_other_allele.outcome = case_when(
        proxy_a1.outcome == effect_allele.outcome & proxy_a2.outcome == other_allele.outcome ~ target_a2.outcome,
        proxy_a2.outcome == effect_allele.outcome & proxy_a1.outcome == other_allele.outcome ~ target_a1.outcome,
        TRUE ~ NA_character_
     ), 
     effect_allele.outcome = new_effect_allele.outcome, 
     other_allele.outcome = new_other_allele.outcome
  ) %>%
  dplyr::select(-proxy_snp, -chr, -pos, -alleles, -maf, -distance, -rsq, -dprime,  
         -new_effect_allele.outcome, -new_other_allele.outcome) %>%
  relocate(target_a1.outcome, proxy_a1.outcome, target_a2.outcome, proxy_a2.outcome, .after = proxy_snp.outcome) %>%
  rename(SNP = snp) %>%
  relocate(SNP, .after = samplesize.outcome)

# Merge outcome and proxy outcomes
outcome_dat <- bind_rows(
  outcome_clump, proxy_outcome
) %>% 
  arrange(chr.outcome, pos.outcome)

outcome_dat
}

```

```{r AD_snoring_proxy}
# extract exposure SNPs present in outcome
snoring_AD_dat <- semi_join(
  snoring_out, AD_dat, by = "SNP"
)

# extract exposure SNPs present in outcome
snoringbmiadj_AD_dat <- semi_join(
  snorbmiadj_out, AD_dat, by = "SNP"
)

# extract exposure SNPs present in outcome
snoring_bmi_dat <- semi_join(
  snoring_out, BMI_dat, by = "SNP"
)

# extract exposure SNPs present in outcome
snoringbmiadj_bmi_dat <- semi_join(
  snorbmiadj_out, BMI_dat, by = "SNP"
)
```


## Harmonize Exposure - Outcome Datasets 
```{r harmonize SAsnoring-AD}
Snor_AD_mr_dat <- harmonise_data(AD_dat, snoring_AD_dat, action = 2) %>% 
    as_tibble() %>%
    mutate(
      apoe_region = case_when(
        chr.outcome == 19 & between(pos.outcome, 44912079, 45912079) ~ TRUE,
        TRUE ~ FALSE
      ), 
      gws.outcome = ifelse(pval.outcome < 5e-8, TRUE, FALSE), 
      # mr_keep_new = ifelse(Outliers != "Outlier" | apoe_region != FALSE | gws.outcome != FALSE, TRUE, FALSE)
      # mr_keep = ifelse(mr_keep == FALSE | apoe_region == TRUE | gws.outcome == TRUE, FALSE, TRUE)
      mr_keep = ifelse(mr_keep == FALSE | gws.outcome == TRUE, FALSE, TRUE)
  )

SnorBMIadj_AD_mr_dat <- harmonise_data(AD_dat, snoringbmiadj_AD_dat, action = 2) %>% 
    as_tibble() %>%
    mutate(
      apoe_region = case_when(
        chr.outcome == 19 & between(pos.outcome, 44912079, 45912079) ~ TRUE,
        TRUE ~ FALSE
      ), 
      gws.outcome = ifelse(pval.outcome < 5e-8, TRUE, FALSE), 
      # mr_keep_new = ifelse(Outliers != "Outlier" | apoe_region != FALSE | gws.outcome != FALSE, TRUE, FALSE)
      # mr_keep = ifelse(mr_keep == FALSE | apoe_region == TRUE | gws.outcome == TRUE, FALSE, TRUE)
      mr_keep = ifelse(mr_keep == FALSE | gws.outcome == TRUE, FALSE, TRUE)
  )

Snor_BMI_mr_dat <- harmonise_data(BMI_dat, snoring_bmi_dat, action = 2) %>% 
    as_tibble() %>%
    mutate(
      gws.outcome = ifelse(pval.outcome < 5e-8, TRUE, FALSE), 
      # mr_keep_new = ifelse(Outliers != "Outlier" | apoe_region != FALSE | gws.outcome != FALSE, TRUE, FALSE)
      mr_keep = ifelse(mr_keep == FALSE | gws.outcome == TRUE, FALSE, TRUE)
  )

SnorBMIadj_BMI_mr_dat <- harmonise_data(BMI_dat, snoringbmiadj_bmi_dat, action = 2) %>% 
    as_tibble() %>%
    mutate(
      gws.outcome = ifelse(pval.outcome < 5e-8, TRUE, FALSE), 
      # mr_keep_new = ifelse(Outliers != "Outlier" | apoe_region != FALSE | gws.outcome != FALSE, TRUE, FALSE)
      mr_keep = ifelse(mr_keep == FALSE | gws.outcome == TRUE, FALSE, TRUE)
  )


mrdat <- bind_rows(
  Snor_AD_mr_dat, SnorBMIadj_AD_mr_dat, Snor_BMI_mr_dat, SnorBMIadj_BMI_mr_dat
)


write_csv(mrdat, 'data/ad_bmi_snoring_harmonized_data.csv')

```

## Perform MR analysis 
```{r MR}
# mrdat <- AD_Snor_mr_dat
mr_res <- mr(mrdat, method_list = c("mr_ivw_fe", "mr_egger_regression", "mr_weighted_median", "mr_weighted_mode"))

mr_res

```


## Perform Sensentivity analysis
```{r sensetivity}
# Heterogeneity statistics 
het_res <-mr_heterogeneity(mrdat, method_list = c("mr_egger_regression", "mr_ivw"))

# Horizontal pleitropy
plei_res <- mr_pleiotropy_test(mrdat)

# Leave-one-out analysis 
res_loo <- mr_leaveoneout(mrdat, method = mr_ivw_fe) %>% as_tibble()

# Single SNP anlaysis 
res_single <- mr_singlesnp(mrdat, all_method = c("mr_ivw_fe", "mr_egger_regression", "mr_weighted_median", "mr_weighted_mode")) %>% as_tibble()

# Radial MR 
radial_dat <- mrdat %>% filter(mr_keep == T) %>% dat_to_RadialMR()
radial_res <- map(radial_dat, function(x){
    ivw_radial(x, alpha = 0.05/nrow(x))
  }
)


# Phenoscanner 
phewas_dat <- phenoscanner(snpquery=radial_res$outliers$SNP) 
```

```{r export_results}
write_csv(mr_res, 'results/ad_bmi_sleep_mr_results.csv')
write_csv(het_res, 'results/ad_bmi_sleep_het_results.csv')
write_csv(plei_res, 'results/ad_bmi_sleep_plei_results.csv')
```


## Plots 
```{r plots}
scatter_p <- mr_scatter_plot(mr_res, mrdat)
scatter_p

loo_p <- mr_leaveoneout_plot(res_loo)
loo_p

funnel_p <- mr_funnel_plot(res_single)
funnel_p

radial_p <-  map(radial_res, function(x){
     plot_radial(x, radial_scale = F, show_outliers = T)
  }
)

```


## MVMR
```{r}

bmi_ad_snps <- bind_rows(
  AD_exp %>% filter(pval.exposure < 5e-8), 
  bmi_exp %>% filter(pval.exposure < 5e-8), 
) %>%
  select(SNP, pval.exposure, exposure) %>%
  pivot_wider(names_from = exposure, values_from = pval.exposure) %>%
  mutate(pval.exposure = pmin(AD, BMI, na.rm = T)) 


test <- bmi_ad_snps %>% 
  clump_data(.,
  clump_kb = 10000,
  clump_r2 = 0.001,
  clump_p1 = 1,
  clump_p2 = 1,
  pop = "EUR"
)

bmi_ad_dat <- bind_rows(
  AD_exp %>% filter(SNP %in% test$SNP), 
  bmi_exp %>% filter(SNP %in% test$SNP), 
)

snoring_mvmr_out <- snoring_out %>% filter(SNP %in% test$SNP)
# snoring_mvmr_out <- snorbmiadj_out %>% filter(SNP %in% test$SNP)

bmi_ad_mvdat <- mv_harmonise_data(bmi_ad_dat, snoring_mvmr_out)
bmi_ad_res <- mv_multiple(bmi_ad_mvdat)
bmi_ad_res

test <- cbind(bmi_ad_mvdat$exposure_beta, 
      bmi_ad_mvdat$exposure_se, 
      bmi_ad_mvdat$outcome_beta, 
      bmi_ad_mvdat$outcome_se) %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  as.matrix()


F.data <- format_mvmr(BXGs = test[,c(2,3)],
                    BYG = test[,6],
                    seBXGs = test[,c(4,5)],
                    seBYG = test[,7],
                    RSID = test[,1])

sres <- strength_mvmr(r_input = F.data, gencov = 0)

res <- ivw_mvmr(r_input = F.data)

mvmrcovmatrix<-matrix(c(1,-0.1,-0.05,-0.1,1,0.2,-0.05,0.2,1), nrow = 3, ncol = 3)
Xcovmat<-phenocov_mvmr(mvmrcovmatrix,F.data[,7:9])
sres2 <- strength_mvmr(r_input = F.data, gencov = Xcovmat)

pres <- pleiotropy_mvmr(r_input = F.data, gencov = 0)

id_exposure <- c("ieu-a-299", "ieu-a-300", "ieu-a-302")
id_outcome <- "ieu-a-7"


exposure_dat <- mv_extract_exposures(id_exposure)
outcome_dat <- extract_outcome_data(exposure_dat$SNP, id_outcome)
mvdat <- mv_harmonise_data(exposure_dat, outcome_dat)
res <- mv_multiple(mvdat)
```















































