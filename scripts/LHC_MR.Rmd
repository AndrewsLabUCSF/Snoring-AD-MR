---
title: "LHC-MR"
author: "Shea J. Andrews"
date: "2023-01-18"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd('~/Dropbox/Research/UCSF/Snoring-AD-MR/')

library(tidyverse)
library(lhcMR)

# Define column types for summary statistics
coltypes = cols(
  ID = col_character(),
  CHROM = col_double(),
  POS = col_double(),
  REF = col_character(),
  ALT = col_character(),
  AF = col_double(),
  TRAIT = col_character(),
  BETA = col_double(),
  SE = col_double(),
  Z = col_double(),
  P = col_double(),
  N = col_double(),
  OR = col_double(),
  OR_L95 = col_double(),
  OR_U95 = col_double(),
  DIR = col_character(),
  G1000_ID = col_character(),
  G1000_VARIANT = col_character(),
  DBSNP_ID = col_character(),
  DBSNP_VARIANT = col_character(),
  OLD_ID = col_character(),
  OLD_VARIANT = col_character()
)

```

## Step 1: Reading in and merging Data
```{r ld}
## File paths needed for the analysis
LD.filepath = "~/Dropbox/Research/Data/ReferencePopulations/lhcMR/LDscores_filtered.csv" # LD scores
rho.filepath = "~/Dropbox/Research/Data/ReferencePopulations/lhcMR/LD_GM2_2prm.csv" # local/SNP-specfic LD scores

ld = "~/Dropbox/Research/Data/ReferencePopulations/GenomicSEM/eur_w_ld_chr/"
hm3 = "~/Dropbox/Research/Data/ReferencePopulations/GenomicSEM/w_hm3.snplist"

```

```{r read_exposure}
# Snoring
exposure_path = "~/Dropbox/Research/Data/Summary_Statisitics/Campos2020snor.chrall.CPRA_b37.tsv.gz"
snoring_ss <- read_tsv(exposure_path, comment = "##",  col_types = coltypes, 
                        col_select = c(DBSNP_ID, CHROM, POS, REF, ALT, AF, BETA, SE, Z, P, N))  %>%
  rename(SNP = DBSNP_ID) %>%
  mutate(N = 408000)

# Snoring bmi adjusted 

snorbmi_path = "~/Dropbox/Research/Data/Summary_Statisitics/Campos2020snorbmiadj.chrall.CPRA_b37.tsv.gz"

snorbmiadj_ss <- read_tsv(snorbmi_path, comment = "##",  col_types = coltypes, 
                        col_select = c(DBSNP_ID, CHROM, POS, REF, ALT, AF, BETA, SE, Z, P, N))  %>%
  rename(SNP = DBSNP_ID) %>%
  mutate(N = 407066)


```


```{r read_outcome}
outcome_path = "~/Dropbox/Research/Data/Summary_Statisitics/Kunkle2019load_stage123.chrall.CPRA_b37.tsv.gz"
AD_ss <- read_tsv(outcome_path, comment = "##",  col_types = coltypes, 
                        col_select = c(DBSNP_ID, CHROM, POS, REF, ALT, AF, BETA, SE, Z, P, N))  %>%
  # filter(!(chr.outcome == 19 & between(pos.outcome, 44912079, 45912079)))
  rename(SNP = DBSNP_ID) 

```

```{r merge}
## Step 1
### Snoring 
snoring.names=c("Snoring","AD")
snoring.files = list(snoring_ss, AD_ss)
snoring_df = merge_sumstats(snoring.files, snoring.names, LD.filepath, rho.filepath)


### Snoring bmi adjusted
snorbmiadj.names=c("SnoringBMIadj","AD")
snorbmiadj.files = list(snorbmiadj_ss, AD_ss)
snorbmi_df = merge_sumstats(snorbmiadj.files, snorbmiadj.names, LD.filepath, rho.filepath)

```


## Step 2: Calculating smart starting points for the likelihood optimisation

```{r read_merge}
# Snoring
snoring_SP_list = calculate_SP(snoring_df,snoring.names,run_ldsc=TRUE,run_MR=TRUE,hm3=hm3,ld=ld,nStep = 2,
                       SP_single=3,SP_pair=50,SNP_filter=10)

# Snoring
snorbmi_SP_list = calculate_SP(snorbmi_df,snorbmiadj.names,run_ldsc=TRUE,run_MR=TRUE,hm3=hm3,ld=ld,nStep = 2,
                       SP_single=3,SP_pair=50,SNP_filter=10)

```


## Step 3: Running the likelihood optimisation to estimate the parameters, followed by a block-jackknife procedure to calculate parameter-SE

```{r read_merge}

## Step 3
snoring_res = lhc_mr(snoring_SP_list, snoring.names, paral_method="lapply", nCores = 2, nBlock=200)
snoring_res %>% as_tibble() %>% write_csv(., "results/snoring_lhcmr.csv")

## Step 3
snorbmi_res = lhc_mr(snorbmi_SP_list, snorbmiadj.names, paral_method="lapply", nCores = 2, nBlock=200)
snorbmi_res %>% as_tibble() %>% write_csv(., "results/snorbmi_lhcmr.csv")

```





































